{% extends 'promo/base.html' %}
{% load allauth i18n %}

{% block content %}
<main class="standard__content">
    <h1 class="form__header">WELCOME {% if request.user.is_authenticated %}{{request.user.first_name}}{% endif %}

    </h1>
    
<div class="account__form">
    <form method="POST">
        {% if form.errors %}
            {% for error in form.errors %}
            <span> {{error}}</span>
            {% endfor %}
        {% endif %}
        {% csrf_token %}
        <div class="form__slider">
            <div class="form__slide form__slide--current intro">
                {% comment %} <p>
                    Please complete your registration by filling out the below form.
                </p>
                <p>
                    The information completed in this form will be assigned to your vetting application.
                </p> {% endcomment %}
                <div class="form__control">
                    <div class="form__label">
                        <label>Phone No </label>
                    </div>
                    <div class="form__input--full">
                        
                            {{form.tel_num}}
                    </div>
                </div>
                <p class="form__question">
                    What aspects of the platform are of interest to you?
                </p>
                <div class="form__control">
                    <div class="form__label">
                        <label>Member Services </label>
                    </div>
                    <div class="form__input--full">
                        <div class="custom__checkbox client"/>
                            {{form.is_buyer}}
                        </div>
                    </div>
                    <div class="form__label">
                        <label>Vendor Services </label>
                    </div>
                    <div class="form__input--full">
                        <div class="custom__checkbox vendor"/>
                            {{form.is_vendor}}
                        </div>
                    </div>
                
                </div>
                <button class="form__next-button" disabled >Next</button>
            </div>
       
            <div class="form__slide client">

                <p class="form__question">
                    Which categories would you like to access? Select all that apply.
                </p>
                <div class="form__input--full">
                        {{form.purchase_interests}}
                        <div class="pill-flex client">
                            {% for category in categories %}
        
                            <button class="btn btn-pill">{{category.title}}</button>
                            {% endfor %}
                        </div>
                </div>

                <div class="form__label">
                    <label>Account Range</label>
                </div>
                {{form.purchase_range}}
                <div class="range__slider">
                    <div class="range__button lower" style="left:0%">  </div>
                    <div class="range__container client" style="grid-template-columns:0% 1fr 10%">
                        <div class="range__pad"></div>
                        <div class="range__selected"></div>
                        <div class="range__pad"></div>
                    </div>
                    <div class="range__button upper" style="right:0%">  </div>
                </div>
                <div class="range__values client">
                    <span class="range__value--lower">£10M</span>
                    <span>-</span>
                    <spam class="range__value--upper">£90M</span>
                </div>

                <button class="form__next-button" disabled>Next</button>
            </div>

            <div class="form__slide vendor">

                <p class="form__question">
                    Which categories would you like to list? Select all that apply.
                </p>
                <div class="form__input--full">
                        {{form.consignment_interests}}
                        <div class="pill-flex">
                            {% for category in categories %}
        
                            <button class="btn btn-pill">{{category.title}}</button>
                            {% endfor %}
                        </div>
                </div>

                <div class="form__label">
                    <label>Listing Range </label>
                </div>
                {{form.consignment_range}}
                <div class="range__slider">
                    <div class="range__button lower" style="left:10%">  </div>
                    <div class="range__container vendor" style="grid-template-columns:10% 1fr 10%">
                        <div class="range__pad"></div>
                        <div class="range__selected"></div>
                        <div class="range__pad"></div>
                    </div>
                    <div class="range__button upper" style="right:10%">  </div>
                </div>
                <div class="range__values client">
                    <span class="range__value--lower">10M</span>
                    <span>-</span>
                    <span class="range__value--upper">90M</span>
                </div>

                <button class="form__next-button" disabled>Next</button>
            </div>
            {% if redirect_field_value %}
            <input type="hidden"
                    name="{{ redirect_field_name }}"
                    value="{{ redirect_field_value }}" />
            {% endif %}
        </div>
    </form>
</div>
</main>
{% endblock content %}

{% block scripts %}
<script>

    const rangeButtons = document.querySelectorAll('.range__button');
    const accountRange = [1_000, 500_000]
    const listingRange = [1_000, 500_00]
    const UPPER_VALUE = 100_000_000
    const LOWER_VALUE = 10_000

    const nextButtons = document.querySelectorAll(".form__next-button");
    const form = document.querySelector("form");

    const buySellCheckBoxes = document.querySelectorAll(".custom__checkbox");

    const buySellInterest = [false, false]; 
    const clientServices = [];
    const vendorServices = [];

    const servicePills = document.querySelectorAll(".btn.btn-pill");

    const handleNextButton = (e) => {
        e.preventDefault();
        console.log(event.target);
        const slide = e.target.parentElement;
        slide.classList.remove("form__slide--current");
        let nextSlide;

        if(slide.classList.contains("intro")) {
            console.log("This is the intro slide");
            if(!buySellInterest[0]) {
                nextSlide = slide.nextElementSibling;
                nextSlide = nextSlide.nextElementSibling;
            } else {
                nextSlide = slide.nextElementSibling;

            }
        } else if (slide.classList.contains("client")) {
            console.log("This is the client slide");
            nextSlide = slide.nextElementSibling;
            if(!buySellInterest[1]) {
                form.submit();
                console.log("Submitting the form")
                return;
            }
            console.log("We made it here!")
        }
        if(!nextSlide) {
            form.submit();
            return;
        }
        if (nextSlide.classList.contains("form__slide")) {
            nextSlide.classList.add("form__slide--current");
        }
    }

    nextButtons.forEach(fb => {
        fb.addEventListener('click', (event) => {
            handleNextButton(event);
        });
    })

    //Takes a percentage, from the left or right of the parent div and calculates a monetary value
    const calculateMoneyValue = (xPercent, isLower) => {
        monetaryValue = (xPercent * (UPPER_VALUE - LOWER_VALUE) / 100) + LOWER_VALUE;

        return monetaryValue; 
    }
    
    //Takes an event (touch or mouse down) and calculates the distance from the left or right of the range slider.
    //If it is an upper range, the value is taken away from 100 (%) to calculate the actual percentage from the right.
    const calculateXPosition = (e) => {
        e.preventDefault();
        let isLower;
        let xPos;
        if(e.type.includes("touch")) {
            xPos = e.touches[0].clientX;
        } else {
            console.log(e.clientX)
            xPos = e.clientX;
        }
        let range;
        if(e.target.classList.contains("lower")) {
            isLower = true;
            range = e.target.nextElementSibling;
        } else if (e.target.classList.contains("upper")) {
            isLower = false;
            range = e.target.previousElementSibling;
        } else {return;}
        const lowerBoundary = range.getBoundingClientRect().left;
        const upperBoundary = range.getBoundingClientRect().right;
        const input = range.parentElement.previousElementSibling;

        
        
        let percentage = ((xPos - lowerBoundary) * 100) / (upperBoundary - lowerBoundary);

        percentage = percentage < 0 ? 0 : percentage > 100 ? 100 : percentage;
        if(!isLower) {percentage = 100 - percentage;}
        percentage = Math.round(percentage);

        const cols = range.style.gridTemplateColumns.split(" ");
        //console.log(cols);
        if(isLower) {
            if(range.classList.contains("client")) {
                
                accountRange[0] = calculateMoneyValue(percentage, true);
                console.log(accountRange[0]);

            } else if(range.classList.contains("vendor")) {

                listingRange[0] = calculateMoneyValue(percentage, true);
            }
            e.target.style = `left: ${percentage}%;`
            cols[0] = `${percentage}%`;
        } else {
            if(range.classList.contains("client")) {
                
                accountRange[1] = calculateMoneyValue(100 - percentage, false);
            } else if(range.classList.contains("vendor")) {
                listingRange[1] = calculateMoneyValue(100 - percentage, false);
            }
            e.target.style = `right: ${percentage}%;`
            cols[2] = `${percentage}%`;
        }
        
        range.style.gridTemplateColumns = cols.join(" ");

        const rangeWrapper = range.parentElement; 
        const rangeValues = rangeWrapper.nextElementSibling;
        const rangeFromValue = rangeValues.firstElementChild; 
        const rangeToValue = rangeValues.lastElementChild;
        //console.log(rangeFromValue);
        if(range.classList.contains("client")) {
            rangeFromValue.innerText = humanize(accountRange[0]);
            rangeToValue.innerText = humanize(accountRange[1]);
            input.value = accountRange.join(" - ");
        } else {
            rangeFromValue.innerText = humanize(listingRange[0]);
            rangeToValue.innerText = humanize(listingRange[1]);
            input.value = listingRange.join(" - ");

        }
        
    }

    const humanize = (value) => {
        if(value > 1_000_000) {
            return `£${(Math.round(value / 1_000_00)) / 10 }M`
        }
        if (value > 1_000) {
            
            return `£${value / 1_000}K`
        }
        return `${value}`
    }

    accountRange[0] = calculateMoneyValue(0, true);
    accountRange[1] = calculateMoneyValue(90, false);
    listingRange[0] = calculateMoneyValue(0, true);
    listingRange[1] = calculateMoneyValue(90, false);

    const vendorRangeInput = document.querySelector("#id_consignment_range");
    const clientRangeInput = document.querySelector("#id_purchase_range");

    clientRangeInput.value = accountRange.join(" - ");
    vendorRangeInput.value = listingRange.join(" - ");

    rangeButtons.forEach(b => {
        b.addEventListener('mousedown', e => {
            document.addEventListener('mousemove', calculateXPosition);
            document.addEventListener('mouseup', e => {
                document.removeEventListener('mousemove', calculateXPosition);
            }, {once: true})

        })
        
        b.addEventListener('touchmove', e => {
            calculateXPosition(e)
        })
    });

    const handleCheckboxes = e => {
        const checkBox = e.target.querySelector("input[type='checkbox']");
        if(e.target.classList.contains("vendor")) {
            buySellInterest[1] = !checkBox.checked;
        } else {buySellInterest[0] = !checkBox.checked;}

        console.log(buySellInterest);
        checkBox.checked = !checkBox.checked;
        validateStageOne();
    }

    buySellCheckBoxes.forEach( c => c.addEventListener('click', handleCheckboxes))

    const validateStageOne = () => {
        if (buySellCheckBoxes[1].querySelector("input[type='checkbox']").checked || buySellCheckBoxes[0].querySelector("input[type='checkbox']").checked) {
            nextButtons[0].disabled = false;
        } else {
            nextButtons[0].disabled = true;

        }
    }
    
    servicePills.forEach(sp => {
        sp.addEventListener('click', e => {
            e.preventDefault();
            const pill = e.target;
            const parent = pill.parentElement;
            pill.classList.toggle("selected");
            const input = parent.previousElementSibling;

            if(pill.classList.contains("selected")) {
                if(parent.classList.contains("client")) {
                    clientServices.push(pill.innerText);
                    input.value = clientServices.join(",");
                    nextButtons[1].disabled = false;
                } else {
                    vendorServices.push(pill.innerText);
                    input.value = vendorServices.join(",");
                    nextButtons[2].disabled = false;
                }
                console.log(input.value);
                
            } else {
                if(parent.classList.contains("client")) {
                    let index = clientServices.indexOf(pill.innerText);
                    clientServices.splice(index, 1);
                    input.value = clientServices.join(",");
                    if(!input.value) {
                        nextButtons[1].disabled = true;
                    }
                } else {
                    let index = vendorServices.indexOf(pill.innerText);
                    vendorServices.splice(index, 1);
                    vendorServices.push(pill.innerText);
                    input.value = vendorServices.join(",");
                    if(!input.value) {
                        nextButtons[2].disabled = true;
                    }
                }
                console.log(input.value);
            }
        })
    })
</script>
{% endblock scripts %}